<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Review Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-active {
            border-color: #2563eb; /* blue-600 */
            color: #111827;     /* gray-900 */
        }
        .transition-all { transition: all 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

    <div id="loginScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-100 p-4">
        <div class="w-full max-w-sm bg-white p-8 rounded-xl shadow-lg">
            <h1 class="text-2xl font-bold mb-6 text-center text-gray-800">Food Review Manager</h1>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="loginPassword" class="sr-only">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter Password" required class="w-full border-gray-300 px-3 py-2 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 disabled:bg-blue-400 transition-colors">Login</button>
            </form>
            <div id="loginError" class="text-red-600 text-sm mt-3 text-center hidden"></div>
            <div id="loginLoading" class="text-blue-600 text-sm mt-3 hidden text-center">Authenticating...</div>
        </div>
    </div>

    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 hidden">
        <header class="flex justify-between items-center mb-6 pb-4 border-b">
            <h1 class="text-3xl font-bold text-gray-800">Reviews</h1>
            <button id="logoutBtn" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium hover:bg-gray-100 transition-colors">Logout</button>
        </header>

        <div class="border-b border-gray-200 mb-6">
            <nav class="flex space-x-4">
                <button id="readTab" class="tab py-2 px-1 border-b-2 text-gray-500 hover:border-gray-300 hover:text-gray-700">Read Reviews</button>
                <button id="addTab" class="tab py-2 px-1 border-b-2 text-gray-500 hover:border-gray-300 hover:text-gray-700">Add Review</button>
            </nav>
        </div>

        <div id="addReviewContent" class="hidden">
            <form id="reviewForm" class="space-y-6 bg-white p-6 rounded-lg shadow-md">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="restaurant" class="block text-sm font-medium text-gray-700">Restaurant</label>
                        <input type="text" id="restaurant" name="restaurant" required class="mt-1 w-full border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="foodItem" class="block text-sm font-medium text-gray-700">Food Item</label>
                        <input type="text" id="foodItem" name="foodItem" required class="mt-1 w-full border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <div>
                        <label for="price" class="block text-sm font-medium text-gray-700">Price (£)</label>
                        <input type="number" id="price" name="price" step="0.01" required class="mt-1 w-full border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div id="ratingSelectorsContainer" class="col-span-1 sm:col-span-3 grid grid-cols-1 sm:grid-cols-3 gap-4"></div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Photo (Optional)</label>
                    <input type="file" id="imageUpload" name="imageUpload" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <img id="imagePreview" class="mt-4 max-h-60 w-auto rounded-lg shadow-sm hidden">
                </div>

                <div class="text-right">
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50 transition-colors">Submit Review</button>
                </div>
            </form>
        </div>

        <div id="readReviewsContent" class="hidden">
            <div id="reviewsList" class="space-y-6">
                <p class="text-gray-500 text-center py-8">Loading reviews...</p>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 px-4 py-2 rounded-lg shadow-xl text-white opacity-0 transform translate-y-4 transition-all"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // --- Configuration ---
    const GITHUB_OWNER = "elo613";
    const GITHUB_REPO = "FoodReview";
    const REVIEWS_FILE_PATH = "reviews.json";
    const PAT_FILE = "pat.enc.json";

    // --- 1. API Service: Handles all GitHub communication ---
    const ApiService = {
        _getApiUrl: (path) => `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${encodeURIComponent(path)}`,
        _getRawUrl: (path) => `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/main/${encodeURIComponent(path)}`,

        // NOTE: This XOR cipher is for obfuscation only and provides no real security.
        // It should not be used in a production application with multiple users.
        _xorCipher: (str, key) => str.split('').map((char, i) => String.fromCharCode(char.charCodeAt(0) ^ key.charCodeAt(i % key.length))).join(''),
        _decryptPat: (encryptedData, key) => ApiService._xorCipher(atob(encryptedData), key).trim(),

        async getPat(password) {
            const res = await fetch(`${this._getRawUrl(PAT_FILE)}?t=${Date.now()}`);
            if (!res.ok) throw new Error("Could not fetch PAT file. Ensure it exists in the repo.");
            const { data } = await res.json();
            return this._decryptPat(data, password);
        },

        async fetchReviews() {
            try {
                const res = await fetch(`${this._getRawUrl(REVIEWS_FILE_PATH)}?t=${Date.now()}`);
                if (res.status === 404) return []; // No reviews file yet, return empty.
                if (!res.ok) throw new Error(`Network error: ${res.statusText}`);
                const data = await res.json();
                return Array.isArray(data) ? data : [];
            } catch (error) {
                console.error("Failed to fetch or parse reviews:", error);
                throw new Error("Could not load reviews from GitHub.");
            }
        },

        async _resizeImage(file, maxWidth = 1280) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        if (img.width <= maxWidth) {
                           // No resize needed, just convert to jpeg
                           resolve(img.src.split(',')[1]);
                           return;
                        }
                        const canvas = document.createElement('canvas');
                        const scale = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.85).split(',')[1]);
                    };
                    img.onerror = (e) => reject(new Error("Image loading failed."));
                    img.src = event.target.result;
                };
                reader.onerror = (e) => reject(new Error("File reading failed."));
                reader.readAsDataURL(file);
            });
        },

        async uploadImage(file, token) {
            try {
                const base64Content = await this._resizeImage(file);
                const timestamp = Date.now();
                const sanitizedName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                const fileName = `images/${timestamp}_${sanitizedName}`;
                const url = this._getApiUrl(fileName);
                
                const requestBody = {
                    message: `Upload image: ${file.name}`,
                    content: base64Content
                };

                console.log('Uploading to URL:', url);
                
                const res = await fetch(url, {
                    method: "PUT",
                    headers: { 
                        Authorization: `token ${token}`, 
                        "Content-Type": "application/json" 
                    },
                    body: JSON.stringify(requestBody),
                });
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('Upload error response:', errorText);
                    throw new Error(`Image upload failed: ${res.status} ${res.statusText}`);
                }
                
                const data = await res.json();
                return data.content.download_url;
            } catch (error) {
                console.error('Image upload error:', error);
                throw error;
            }
        },

        async saveReviews(reviews, token) {
            try {
                const url = this._getApiUrl(REVIEWS_FILE_PATH);
                let sha = null;
                
                // Try to get existing file SHA
                try {
                    const existingRes = await fetch(url, { 
                        headers: { Authorization: `token ${token}` } 
                    });
                    if (existingRes.ok) {
                        const existingData = await existingRes.json();
                        sha = existingData.sha;
                    }
                } catch (e) {
                    console.warn("Could not retrieve file SHA. Creating new file.");
                }
                
                // Prepare the content
                const jsonContent = JSON.stringify(reviews, null, 2);
                const base64Content = btoa(unescape(encodeURIComponent(jsonContent)));
                
                const requestBody = { 
                    message: `Update reviews ${new Date().toISOString()}`, 
                    content: base64Content
                };
                
                if (sha) {
                    requestBody.sha = sha;
                }
                
                console.log('Saving to URL:', url);
                
                const res = await fetch(url, {
                    method: "PUT",
                    headers: { 
                        Authorization: `token ${token}`, 
                        "Content-Type": "application/json" 
                    },
                    body: JSON.stringify(requestBody),
                });
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('Save error response:', errorText);
                    throw new Error(`Failed to save reviews: ${res.status} ${res.statusText}`);
                }
                
                return await res.json();
            } catch (error) {
                console.error('Save reviews error:', error);
                throw error;
            }
        },
    };

    // --- 2. UI Manager: Handles all DOM manipulation ---
    const UIManager = {
        elements: {
            loginScreen: document.getElementById("loginScreen"),
            loginForm: document.getElementById("loginForm"),
            loginPassword: document.getElementById("loginPassword"),
            loginError: document.getElementById("loginError"),
            loginLoading: document.getElementById("loginLoading"),
            app: document.getElementById("app"),
            logoutBtn: document.getElementById("logoutBtn"),
            addTab: document.getElementById("addTab"),
            readTab: document.getElementById("readTab"),
            addReviewContent: document.getElementById("addReviewContent"),
            readReviewsContent: document.getElementById("readReviewsContent"),
            reviewForm: document.getElementById("reviewForm"),
            reviewSubmitBtn: document.querySelector("#reviewForm button[type='submit']"),
            reviewsList: document.getElementById("reviewsList"),
            imageUpload: document.getElementById("imageUpload"),
            imagePreview: document.getElementById("imagePreview"),
            toast: document.getElementById("toast"),
            ratingContainer: document.getElementById("ratingSelectorsContainer"),
        },

        showToast(message, isError = false) {
            const { toast } = this.elements;
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white px-4 py-2 rounded-lg shadow-xl transition-all transform ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            toast.classList.remove("opacity-0", "translate-y-4");
            setTimeout(() => toast.classList.add("opacity-0", "translate-y-4"), 3000);
        },

        setLoginState({ isLoading = false, error = null }) {
            this.elements.loginLoading.classList.toggle("hidden", !isLoading);
            this.elements.loginError.textContent = error || '';
            this.elements.loginError.classList.toggle("hidden", !error);
            this.elements.loginForm.querySelector('button').disabled = isLoading;
        },

        _createReviewHTML(review, index) {
            const { restaurant, foodItem, price, image, timestamp, taste, texture, size, value } = review;
            const date = new Date(timestamp).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            return `
                <div class="p-4 border border-gray-200 rounded-lg bg-white flex flex-col" data-index="${index}">
                    ${image ? `<img src="${image}" alt="Photo of ${foodItem}" class="mb-3 max-h-72 w-full object-cover rounded-md">` : ""}
                    <div class="flex-grow">
                        <div class="flex justify-between items-start gap-4">
                            <div>
                                <h3 class="text-xl font-bold text-blue-600">${restaurant}</h3>
                                <p class="text-gray-700">${foodItem} - £${price}</p>
                            </div>
                            <button class="font-semibold text-sm text-red-500 hover:text-red-700 flex-shrink-0" data-action="delete">Delete</button>
                        </div>
                        <div class="mt-2 pt-2 border-t grid grid-cols-2 sm:grid-cols-4 gap-2 text-sm text-gray-600">
                            <span>Taste: <strong>${taste}/10</strong></span>
                            <span>Texture: <strong>${texture}/10</strong></span>
                            <span>Size: <strong>${size}/10</strong></span>
                            <span>Value: <strong>${value}/10</strong></span>
                        </div>
                    </div>
                    <p class="mt-3 text-xs text-gray-400 text-right">Added: ${date}</p>
                </div>`;
        },

        renderReviews(reviews) {
            const { reviewsList } = this.elements;
            if (!reviews || reviews.length === 0) {
                reviewsList.innerHTML = `<p class="text-gray-500 text-center py-8">No reviews yet. Click 'Add Review' to get started!</p>`;
                return;
            }
            reviewsList.innerHTML = [...reviews].reverse()
                .map((review, i) => this._createReviewHTML(review, reviews.length - 1 - i)).join("");
        },
        
        updateView(state) {
            const isLoggedIn = !!state.token;
            this.elements.loginScreen.classList.toggle('hidden', isLoggedIn);
            this.elements.app.classList.toggle('hidden', !isLoggedIn);
            if (!isLoggedIn) return;

            const isAddTab = state.activeTab === 'add';
            this.elements.addTab.classList.toggle('tab-active', isAddTab);
            this.elements.readTab.classList.toggle('tab-active', !isAddTab);
            this.elements.addReviewContent.classList.toggle('hidden', !isAddTab);
            this.elements.readReviewsContent.classList.toggle('hidden', isAddTab);
            this.elements.reviewSubmitBtn.disabled = state.isBusy;
        },

        resetForm() {
            this.elements.reviewForm.reset();
            this.elements.imagePreview.src = '';
            this.elements.imagePreview.classList.add('hidden');
        },

        populateRatingSelectors() {
            const ratings = ['taste', 'texture', 'size', 'value'];
            this.elements.ratingContainer.innerHTML = ratings.map(id => {
                const label = id.charAt(0).toUpperCase() + id.slice(1);
                const options = Array.from({length: 10}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('');
                return `
                    <div>
                        <label for="${id}" class="block text-sm font-medium text-gray-700">${label}</label>
                        <select id="${id}" name="${id}" required class="mt-1 w-full border-gray-300 rounded-md shadow-sm">${options}</select>
                    </div>`;
            }).join('');
        }
    };

    // --- 3. App Controller: Manages state and orchestrates the app ---
    const AppController = {
        state: {
            token: sessionStorage.getItem('github_pat') || null,
            reviews: [],
            activeTab: 'read',
            isBusy: false,
        },

        setState(newState) {
            Object.assign(this.state, newState);
            UIManager.updateView(this.state);
            if (newState.reviews !== undefined) UIManager.renderReviews(this.state.reviews);
        },

        async withLoadingState(asyncFunction) {
            if (this.state.isBusy) return;
            this.setState({ isBusy: true });
            try {
                await asyncFunction();
            } catch (error) {
                console.error("Operation failed:", error);
                UIManager.showToast(error.message, true);
            } finally {
                this.setState({ isBusy: false });
            }
        },

        async init() {
            this.bindEvents();
            UIManager.populateRatingSelectors();
            this.setState({ activeTab: 'read' }); // Set initial view

            if (this.state.token) {
                await this.withLoadingState(async () => {
                    const reviews = await ApiService.fetchReviews();
                    this.setState({ reviews });
                });
            }
        },

        bindEvents() {
            const { elements } = UIManager;
            
            elements.loginForm.addEventListener("submit", (e) => {
                e.preventDefault();
                UIManager.setLoginState({ isLoading: true });
                this.withLoadingState(async () => {
                    const password = elements.loginPassword.value;
                    const token = await ApiService.getPat(password);
                    sessionStorage.setItem('github_pat', token);
                    const reviews = await ApiService.fetchReviews();
                    this.setState({ token, reviews, activeTab: 'read' });
                }).catch(err => UIManager.setLoginState({ error: err.message }))
                  .finally(() => UIManager.setLoginState({ isLoading: false }));
            });

            elements.logoutBtn.addEventListener("click", () => {
                sessionStorage.removeItem('github_pat');
                this.setState({ token: null, reviews: [] });
            });
            
            elements.reviewForm.addEventListener("submit", (e) => {
                e.preventDefault();
                this.withLoadingState(async () => {
                    UIManager.showToast("Submitting review...");
                    const form = e.target;
                    const imageFile = elements.imageUpload.files[0];
                    let imageUrl = "";

                    if (imageFile) {
                        UIManager.showToast("Uploading image...");
                        imageUrl = await ApiService.uploadImage(imageFile, this.state.token);
                    }
                    
                    const newReview = Object.fromEntries(new FormData(form));
                    newReview.price = parseFloat(newReview.price).toFixed(2);
                    newReview.image = imageUrl;
                    newReview.timestamp = new Date().toISOString();
                    
                    const updatedReviews = [...this.state.reviews, newReview];
                    UIManager.showToast("Saving review...");
                    await ApiService.saveReviews(updatedReviews, this.state.token);
                    
                    this.setState({ reviews: updatedReviews, activeTab: 'read' });
                    UIManager.resetForm();
                    UIManager.showToast("Review added successfully!");
                });
            });

            elements.reviewsList.addEventListener('click', (e) => {
                if (e.target.dataset.action !== 'delete' || !confirm("Are you sure you want to delete this review?")) return;
                this.withLoadingState(async () => {
                    UIManager.showToast("Deleting review...");
                    const index = parseInt(e.target.closest('[data-index]').dataset.index, 10);
                    const updatedReviews = this.state.reviews.filter((_, i) => i !== index);
                    await ApiService.saveReviews(updatedReviews, this.state.token);
                    this.setState({ reviews: updatedReviews });
                    UIManager.showToast("Review deleted successfully!");
                });
            });
            
            elements.imageUpload.addEventListener("change", (e) => {
                const file = e.target.files[0];
                const { imagePreview } = elements;
                if (file) {
                    const reader = new FileReader();
                    reader.onload = ev => { imagePreview.src = ev.target.result; imagePreview.classList.remove("hidden"); };
                    reader.readAsDataURL(file);
                } else {
                    imagePreview.src = ''; imagePreview.classList.add("hidden");
                }
            });

            elements.addTab.addEventListener("click", () => this.setState({ activeTab: 'add' }));
            elements.readTab.addEventListener("click", () => this.setState({ activeTab: 'read' }));
        }
    };

    // Start the application
    AppController.init();
});
</script>
</body>
</html>
